// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Gender {
  MALE
  FEMALE
}

enum Region {
  TOSHKENT_SHAHAR
  TOSHKENT_VILOYATI
  ANDIJON
  BUXORO
  FARGONA
  JIZZAX
  XORAZM
  NAMANGAN
  NAVOIY
  QASHQADARYO
  QORAQALPOGISTON
  SAMARQAND
  SIRDARYO
  SURXONDARYO
}

enum PaymentMethod {
  CLICK
  PAYME
  UZUM
  BALANCE
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  CANCELLED
}

enum PaymentType {
  COURSE_PURCHASE
  BALANCE_TOPUP
}

enum TestAvailability {
  ANYTIME          // Har doim
  DAILY            // Har kuni
  EVERY_3_DAYS     // Har 3 kunda
  WEEKLY           // Har haftada
  MONTHLY          // Har oyda
  YEARLY           // Har yilda
}

enum PromoCodeType {
  SINGLE_USE      // Bir martalik
  USER_SINGLE_USE // Har bir user uchun bir martalik
  UNLIMITED       // Cheksiz
}

model User {
  id              Int              @id @default(autoincrement())
  phone           String           @unique @db.VarChar(13)
  email           String?          @unique @db.VarChar(255)
  firstName       String?          @db.VarChar(100)
  surname         String?          @db.VarChar(100)
  avatar          String?          @db.VarChar(500)
  gender          Gender?
  region          Region?
  balance         Decimal          @db.Decimal(10, 2) @default(0)
  isVerified      Boolean          @default(false)
  isActive        Boolean          @default(true)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  
  verificationCodes VerificationCode[]
  enrollments       Enrollment[]
  feedbacks         Feedback[]
  savedCourses      SavedCourse[]
  payments          Payment[]
  comments          CourseComment[]
  testResults       TestResult[]
  testSessions      TestSession[]
  certificates      Certificate[]
  teacher           Teacher?
  notifications     Notification[]
  promoCodeUsages   PromoCodeUsage[]
  teacherRatings    TeacherRating[]
  courseRatings     CourseRating[]

  @@index([phone])
  @@index([email])
}

model VerificationCode {
  id          Int      @id @default(autoincrement())
  userId      Int
  code        String   @db.VarChar(6)
  expiresAt   DateTime
  isUsed      Boolean  @default(false)
  createdAt   DateTime @default(now())
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([code])
}

model Teacher {
  id          Int       @id @default(autoincrement())
  userId      Int?      @unique
  name        String    @db.VarChar(255)
  bio         String?   @db.Text
  email       String?   @unique @db.VarChar(255)
  phone       String?   @db.VarChar(13)
  avatar      String?   @db.VarChar(500)
  rating      Float     @default(0)
  totalRatings Int      @default(0)
  categories  String?   @db.VarChar(500)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  user        User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  courses     Course[]
  ratings     TeacherRating[]

  @@index([email])
  @@index([userId])
}

model Category {
  id          Int       @id @default(autoincrement())
  name        String    @db.VarChar(100)
  nameUz      String    @db.VarChar(100)
  icon        String?   @db.VarChar(500)
  image       String?   @db.VarChar(500)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  
  courses     Course[]

  @@index([name])
}

model Course {
  id              Int           @id @default(autoincrement())
  teacherId       Int
  categoryId      Int
  title           String        @db.VarChar(255)
  subtitle        String?       @db.VarChar(500)
  description     String?       @db.Text
  thumbnail       String?       @db.VarChar(500)
  price           Decimal       @db.Decimal(10, 2) @default(0)
  isFree          Boolean       @default(false)
  freeVideosCount Int           @default(0)
  duration        Int?          // in minutes
  level           String?       @db.VarChar(50)
  hasCertificate  Boolean       @default(true)
  rating          Decimal       @db.Decimal(3, 2) @default(0)
  totalStudents   Int           @default(0)
  isActive        Boolean       @default(true)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  teacher         Teacher       @relation(fields: [teacherId], references: [id])
  category        Category      @relation(fields: [categoryId], references: [id])
  sections        Section[]
  videos          Video[]
  enrollments     Enrollment[]
  feedbacks       Feedback[]
  savedCourses    SavedCourse[]
  comments        CourseComment[]
  faqs            CourseFAQ[]
  banners         Banner[]
  tests           Test[]
  payments        Payment[]
  promoCodeUsages PromoCodeUsage[]
  ratings         CourseRating[]

  @@index([teacherId])
  @@index([categoryId])
  @@index([title])
}

model Section {
  id          Int       @id @default(autoincrement())
  courseId    Int
  title       String    @db.VarChar(255)
  description String?   @db.Text
  order       Int       @default(0)
  isFree      Boolean   @default(false)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  course      Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  videos      Video[]

  @@index([courseId])
  @@index([order])
}

model Video {
  id          Int       @id @default(autoincrement())
  courseId    Int
  sectionId   Int?
  title       String    @db.VarChar(255)
  subtitle    String?   @db.VarChar(500)
  description String?   @db.Text
  url         String    @db.VarChar(500)
  thumbnail   String?   @db.VarChar(500)
  duration    Int?      // in seconds
  size        BigInt?   // in bytes
  order       Int       @default(0)
  isFree      Boolean   @default(false)
  screenshots String?   @db.Text // JSON array of screenshot URLs
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  course      Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  section     Section?  @relation(fields: [sectionId], references: [id], onDelete: SetNull)

  @@index([courseId])
  @@index([sectionId])
  @@index([order])
}

model Test {
  id                    Int               @id @default(autoincrement())
  courseId              Int
  title                 String            @db.VarChar(255)
  description           String?           @db.Text
  duration              Int               // in minutes (timer)
  maxDuration           Int               @default(60) // max vaqt (minutes) - default 1 soat
  passingScore          Int               @default(70) // percentage
  minCorrectAnswers     Int               @default(18) // minimum to'g'ri javoblar certificate uchun
  availabilityType      TestAvailability  @default(ANYTIME)
  availableAfterDays    Int               @default(0) // kurs sotib olingandan keyin necha kundan so'ng
  isActive              Boolean           @default(true)
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  
  course                Course            @relation(fields: [courseId], references: [id], onDelete: Cascade)
  questions             TestQuestion[]
  results               TestResult[]
  sessions              TestSession[]

  @@index([courseId])
}

model TestQuestion {
  id            Int                 @id @default(autoincrement())
  testId        Int
  question      String              @db.Text
  options       String              @db.Text // JSON array of options
  correctAnswer Int                 // index of correct option
  order         Int                 @default(0)
  createdAt     DateTime            @default(now())
  
  test          Test                @relation(fields: [testId], references: [id], onDelete: Cascade)
  sessionAnswers TestSessionAnswer[]

  @@index([testId])
}

model TestSession {
  id              Int       @id @default(autoincrement())
  userId          Int
  testId          Int
  startedAt       DateTime  @default(now())
  expiresAt       DateTime  // startedAt + maxDuration
  submittedAt     DateTime? // test tugallanganda
  isExpired       Boolean   @default(false)
  isSubmitted     Boolean   @default(false)
  currentAnswers  String    @db.Text // JSON: {questionId: selectedAnswer}
  
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  test            Test      @relation(fields: [testId], references: [id], onDelete: Cascade)
  answers         TestSessionAnswer[]

  @@index([userId])
  @@index([testId])
  @@index([isExpired])
}

model TestSessionAnswer {
  id              Int         @id @default(autoincrement())
  sessionId       Int
  questionId      Int
  selectedAnswer  Int         // tanlangan javob indexi
  answeredAt      DateTime    @default(now())
  
  session         TestSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  question        TestQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([sessionId, questionId]) // Har bir savolga faqat 1 marta javob
  @@index([sessionId])
  @@index([questionId])
}

model TestResult {
  id              Int           @id @default(autoincrement())
  userId          Int
  testId          Int
  score           Int           // percentage
  correctAnswers  Int           // to'g'ri javoblar soni
  totalQuestions  Int           // jami savollar soni
  answers         String        @db.Text // JSON array of user answers
  isPassed        Boolean       @default(false)
  completedAt     DateTime      @default(now())
  
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  test            Test          @relation(fields: [testId], references: [id], onDelete: Cascade)
  certificates    Certificate[]

  @@index([userId])
  @@index([testId])
}

model Certificate {
  id            Int        @id @default(autoincrement())
  userId        Int
  courseId      Int?
  testResultId  Int        @unique
  certificateNo String     @unique @db.VarChar(100)
  pdfUrl        String?    @db.VarChar(500)
  issuedAt      DateTime   @default(now())
  
  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  testResult    TestResult @relation(fields: [testResultId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([certificateNo])
}

model CourseFAQ {
  id          Int       @id @default(autoincrement())
  courseId    Int
  question    String    @db.Text
  answer      String    @db.Text
  order       Int       @default(0)
  createdAt   DateTime  @default(now())
  
  course      Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([courseId])
}

model CourseComment {
  id          Int       @id @default(autoincrement())
  userId      Int
  courseId    Int
  comment     String    @db.Text
  rating      Int?      // 1-5
  images      String?   @db.Text // JSON array of image URLs
  screenshots String?   @db.Text // JSON array of screenshot URLs
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  course      Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([courseId])
  @@index([createdAt])
}

model Enrollment {
  id          Int       @id @default(autoincrement())
  userId      Int
  courseId    Int
  isActive    Boolean   @default(true)
  enrolledAt  DateTime  @default(now())
  expiresAt   DateTime?
  
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  course      Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
}

model Feedback {
  id          Int       @id @default(autoincrement())
  userId      Int
  courseId    Int
  rating      Int       @db.TinyInt // 1-5
  comment     String?   @db.Text
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  course      Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
  @@index([rating])
}

model SavedCourse {
  id          Int       @id @default(autoincrement())
  userId      Int
  courseId    Int
  savedAt     DateTime  @default(now())
  
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  course      Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
}

model Banner {
  id          Int       @id @default(autoincrement())
  title       String    @db.VarChar(255)
  description String?   @db.Text
  image       String    @db.VarChar(500)
  courseId    Int?
  link        String?   @db.VarChar(500)
  isActive    Boolean   @default(true)
  order       Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  course      Course?   @relation(fields: [courseId], references: [id], onDelete: SetNull)

  @@index([isActive])
  @@index([courseId])
}

model Notification {
  id          Int       @id @default(autoincrement())
  userId      Int
  title       String    @db.VarChar(255)
  message     String    @db.Text
  type        String    @db.VarChar(50) // 'course', 'discount', 'certificate', 'video'
  icon        String?   @db.VarChar(100)
  image       String?   @db.VarChar(500)
  link        String?   @db.VarChar(500)
  isRead      Boolean   @default(false)
  createdAt   DateTime  @default(now())
  
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

model PromoCode {
  id              Int             @id @default(autoincrement())
  code            String          @unique @db.VarChar(50)
  discountPercent Int?            // 10 = 10%, null if using discountAmount
  discountAmount  Decimal?        @db.Decimal(10, 2) // Fixed amount discount, null if using discountPercent
  type            PromoCodeType   @default(USER_SINGLE_USE)
  maxUsageCount   Int?            // Null = unlimited
  currentUsageCount Int           @default(0)
  expiresAt       DateTime?
  isActive        Boolean         @default(true)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  usages          PromoCodeUsage[]
  payments        Payment[]

  @@index([code])
  @@index([isActive])
  @@index([expiresAt])
}

model PromoCodeUsage {
  id          Int       @id @default(autoincrement())
  userId      Int
  promoCodeId Int
  courseId    Int
  discount    Decimal   @db.Decimal(10, 2)
  usedAt      DateTime  @default(now())
  
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  promoCode   PromoCode @relation(fields: [promoCodeId], references: [id], onDelete: Cascade)
  course      Course    @relation(fields: [courseId], references: [id])

  @@unique([userId, promoCodeId]) // Har bir user bir promocode'ni faqat bir marta ishlatadi
  @@index([userId])
  @@index([promoCodeId])
  @@index([courseId])
}

model Payment {
  id              Int           @id @default(autoincrement())
  userId          Int
  courseId        Int?
  promoCodeId     Int?
  amount          Decimal       @db.Decimal(10, 2)
  originalAmount  Decimal?      @db.Decimal(10, 2) // Original price before discount
  discount        Decimal?      @db.Decimal(10, 2) // Discount amount applied
  method          PaymentMethod
  type            PaymentType   @default(COURSE_PURCHASE)
  status          PaymentStatus @default(PENDING)
  transactionId   String?       @unique @db.VarChar(255)
  paymentDate     DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  user            User          @relation(fields: [userId], references: [id])
  course          Course?       @relation(fields: [courseId], references: [id])
  promoCode       PromoCode?    @relation(fields: [promoCodeId], references: [id])

  @@index([userId])
  @@index([courseId])
  @@index([promoCodeId])
  @@index([transactionId])
  @@index([status])
  @@index([type])
}

model TeacherRating {
  id          Int      @id @default(autoincrement())
  userId      Int
  teacherId   Int
  rating      Int      // 1-5
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  teacher     Teacher  @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@unique([userId, teacherId]) // Har bir user bir teacherni faqat bir marta baholaydi
  @@index([userId])
  @@index([teacherId])
  @@index([rating])
}

model CourseRating {
  id          Int      @id @default(autoincrement())
  userId      Int
  courseId    Int
  rating      Int      // 1-5
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId]) // Har bir user bir kursni faqat bir marta baholaydi
  @@index([userId])
  @@index([courseId])
  @@index([rating])
}
